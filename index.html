<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Math & Physics App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

```
<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a3a2e 0%, #2d5f4d 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 10px;
        box-sizing: border-box;
    }

    .app-container {
        width: 100%;
        max-width: 500px;
        min-height: 600px;
        background: linear-gradient(135deg, #234d3f 0%, #2d6552 100%);
        position: relative;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .panel {
        width: 100%;
        min-height: 600px;
        position: absolute;
        top: 0;
        left: 0;
        display: none;
    }

    .panel.active {
        display: block;
    }

    .btn {
        background: linear-gradient(135deg, #4a9d7f 0%, #3d8568 100%);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        font-weight: 600;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        touch-action: manipulation;
    }

    .btn:hover {
        background: linear-gradient(135deg, #5bb594 0%, #4a9d7f 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
        background: linear-gradient(135deg, #3d8568 0%, #2d6552 100%);
        transform: translateY(0);
    }

    @media (hover: none) {
        .btn:hover {
            transform: none;
        }
    }

    #homeTitle {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        color: #e8f5e9;
        font-size: 28px;
        font-weight: 700;
        text-align: center;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Home panel buttons */
    .home-btn {
        width: 100px;
        height: 40px;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }

    #btnStart {
        top: 150px;
    }

    #btnReset {
        top: 200px;
    }

    #btnXOnly {
        top: 250px;
    }

    #btnImport {
        top: 300px;
    }

    /* Import panel */
    #importPanel {
        padding: 20px;
    }

    #driveBtn {
        display: block;
        margin: 20px auto;
        width: 200px;
        height: 50px;
    }

    .or-divider {
        text-align: center;
        color: #c8e6c9;
        margin: 20px 0;
        font-weight: 500;
    }

    #fileInput {
        display: block;
        margin: 20px auto;
    }

    #sheetSelector {
        width: 300px;
        padding: 8px;
        margin: 20px auto;
        display: block;
        font-size: 14px;
    }

    #importBtn {
        display: block;
        margin: 20px auto;
        width: 150px;
        height: 40px;
    }

    #backBtn {
        display: block;
        margin: 20px auto;
        width: 150px;
        height: 40px;
    }

    #importStatus {
        text-align: center;
        margin-top: 20px;
        color: #c8e6c9;
        font-weight: 500;
    }

    /* Quiz panel elements */
    #wordLabel {
        position: absolute;
        top: 30px;
        left: 5%;
        width: 90%;
        max-height: 100px;
        overflow-y: auto;
        font-size: 20px;
        font-weight: 700;
        text-align: center;
        color: #e8f5e9;
        padding: 10px;
        box-sizing: border-box;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    /* Input fields container */
    .input-container {
        position: absolute;
        top: 145px;
        left: 5%;
        width: 90%;
    }

    .input-group {
        margin-bottom: 12px;
    }

    .input-label {
        display: block;
        color: #c8e6c9;
        font-size: 14px;
        margin-bottom: 5px;
        font-weight: 600;
    }

    .input-field {
        width: 100%;
        padding: 12px;
        border: 2px solid #4a9d7f;
        border-radius: 6px;
        font-size: 16px;
        background: #1a3a2e;
        color: #e8f5e9;
        box-sizing: border-box;
        resize: vertical;
        -webkit-appearance: none;
        appearance: none;
    }

    .input-field:focus {
        outline: none;
        border-color: #5bb594;
        background: #234d3f;
    }

    textarea.input-field {
        min-height: 50px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #infoLabel {
        position: absolute;
        top: 390px;
        left: 5%;
        width: 90%;
        max-height: 90px;
        overflow-y: auto;
        font-size: 14px;
        text-align: left;
        color: #c8e6c9;
        white-space: pre-line;
        padding: 10px;
        box-sizing: border-box;
        line-height: 1.5;
        word-wrap: break-word;
        overflow-wrap: break-word;
        background: rgba(26, 58, 46, 0.6);
        border-radius: 6px;
        border: 2px solid #4a9d7f;
    }

    #checkResult {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 450px;
        text-align: center;
        font-size: 15px;
        font-weight: 700;
        padding: 12px;
        border-radius: 8px;
        display: none;
        z-index: 1000;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    #checkResult.correct {
        background: rgba(76, 175, 80, 0.95);
        color: white;
        border: 2px solid #4caf50;
        animation: slideDown 0.3s ease-out;
    }

    #checkResult.incorrect {
        background: rgba(244, 67, 54, 0.95);
        color: white;
        border: 2px solid #f44336;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            transform: translateX(-50%) translateY(-100px);
            opacity: 0;
        }
        to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    }

    .quiz-btn {
        width: 80px;
        height: 42px;
        position: absolute;
        font-size: 15px;
    }

    #btnCheck {
        top: 335px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 44px;
    }

    #btnCorrect {
        top: 490px;
        left: 50%;
        transform: translateX(-85px);
        width: 75px;
    }

    #btnWrong {
        top: 490px;
        left: 50%;
        transform: translateX(10px);
        width: 75px;
    }

    #btnNext {
        top: 540px;
        left: 50%;
        transform: translateX(-85px);
        width: 75px;
    }

    #btnHome {
        top: 540px;
        left: 50%;
        transform: translateX(10px);
        width: 75px;
    }
</style>
```

</head>

<body>
    <div class="app-container">
        <!-- Home Panel -->
        <div id="homePanel" class="panel active">
            <h1 id="homeTitle">Math & Physics App</h1>
            <button id="btnStart" class="btn home-btn">Start</button>
            <button id="btnReset" class="btn home-btn">Reset</button>
            <button id="btnXOnly" class="btn home-btn">√ó Only</button>
            <button id="btnImport" class="btn home-btn">Import</button>
        </div>

```
    <!-- Import Panel -->
    <div id="importPanel" class="panel">
        <h2 style="text-align: center; color: #e8f5e9; padding-top: 20px;">Import Excel File</h2>

        <button id="driveBtn" class="btn">üìÅ Open from Google Drive</button>

        <div class="or-divider">OR</div>

        <input type="file" id="fileInput" accept=".xlsx, .xls" />
        <select id="sheetSelector"
            style="display: none; background: #2d5f4d; color: #e8f5e9; border: 1px solid #4a9d7f;">
            <option value="">Select a sheet...</option>
        </select>
        <button id="importBtn" class="btn" style="display: none;">Load Selected Sheet</button>
        <button id="backBtn" class="btn">Back</button>
        <div id="importStatus"></div>
    </div>

    <!-- Quiz Panel -->
    <div id="quizPanel" class="panel">
        <div id="wordLabel"></div>
        
        <div class="input-container">
            <div class="input-group">
                <label class="input-label">Calculation Workspace:</label>
                <textarea id="calculationInput" class="input-field" placeholder="Work out your calculation here..."></textarea>
            </div>
            <div class="input-group">
                <label class="input-label">Your Answer:</label>
                <input type="text" id="answerInput" class="input-field" placeholder="Enter your answer...">
            </div>
        </div>

        <button id="btnCheck" class="btn quiz-btn">Check</button>
        <div id="checkResult"></div>
        <div id="infoLabel"></div>
        
        <button id="btnNext" class="btn quiz-btn">Next</button>
        <button id="btnHome" class="btn quiz-btn">Home</button>
        <button id="btnCorrect" class="btn quiz-btn">„Äá</button>
        <button id="btnWrong" class="btn quiz-btn">√ó</button>
    </div>
</div>

<script>
    // Google API Configuration
    const CLIENT_ID = "601060783093-tgptd20ntvutjccv572qaeflv03o9sa0.apps.googleusercontent.com";
    const API_KEY = "AIzaSyCh_DOXRrH0S68ELv-DVWtrzyFTKS80gjI";
    const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

    let tokenClient;
    let accessToken = null;
    let pickerInited = false;
    let gisInited = false;

    // Default sample problem data (Excel columns: Problem, Answer, Calculation Process)
    let allWords = [
        { word: "2 + 3 = ?", answer: "5", calculationProcess: "2 + 3 = 5" },
        { word: "Velocity 5 m/s for 10 seconds. Distance = ?", answer: "50 m", calculationProcess: "Distance = Velocity √ó Time = 5 √ó 10 = 50 m" },
        { word: "‚àö16 = ?", answer: "4", calculationProcess: "‚àö16 = 4 (4¬≤ = 16)" },
        { word: "Work done by 10N force over 5m = ?", answer: "50 J", calculationProcess: "Work = Force √ó Distance = 10 √ó 5 = 50 J" },
        { word: "Expand (x + 2)(x - 3)", answer: "x¬≤ - x - 6", calculationProcess: "x¬≤ - 3x + 2x - 6 = x¬≤ - x - 6" },
        { word: "Force to accelerate 2kg mass at 3m/s¬≤ = ?", answer: "6 N", calculationProcess: "F = ma = 2 √ó 3 = 6 N" },
        { word: "sin(30¬∞) = ?", answer: "1/2", calculationProcess: "sin(30¬∞) = 1/2" },
        { word: "Kinetic Energy (mass 2kg, velocity 3m/s) = ?", answer: "9 J", calculationProcess: "E = (1/2)mv¬≤ = (1/2) √ó 2 √ó 3¬≤ = 9 J" }
    ];

    // Store Excel workbook temporarily
    let workbook = null;

    // Application state
    let state = {
        remainingIdx: Array.from({ length: allWords.length }, (_, i) => i),
        wrongWords: [],
        correctWords: [],
        currentWordIdx: -1,
        xOnlyMode: false
    };

    // Initialize Google APIs
    function gapiLoaded() {
        gapi.load('picker', () => {
            pickerInited = true;
            console.log('Picker API loaded');
        });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // defined later
        });
        gisInited = true;
        console.log('GIS loaded');
    }

    // Create and render Google Picker
    function openDrivePicker() {
        if (!pickerInited || !gisInited) {
            document.getElementById('importStatus').textContent = 'Google services are still loading... Please wait.';
            return;
        }

        const showPicker = () => {
            const view = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
                .setIncludeFolders(true)
                .setMimeTypes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel');

            const picker = new google.picker.PickerBuilder()
                .addView(view)
                .setOAuthToken(accessToken)
                .setDeveloperKey(API_KEY)
                .setCallback(pickerCallback)
                .setOrigin(window.location.protocol + '//' + window.location.host)
                .build();
            picker.setVisible(true);
        };

        tokenClient.callback = async (response) => {
            if (response.error !== undefined) {
                document.getElementById('importStatus').textContent = 'Authentication failed: ' + response.error;
                return;
            }
            accessToken = response.access_token;
            showPicker();
        };

        if (accessToken === null) {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
            tokenClient.requestAccessToken({ prompt: '' });
        }
    }

    // Handle file selection from Google Picker
    async function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
            const fileId = data.docs[0].id;
            const fileName = data.docs[0].name;

            document.getElementById('importStatus').textContent = `Loading ${fileName}...`;

            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to download file from Google Drive');
                }

                const blob = await response.blob();
                const arrayBuffer = await blob.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                workbook = XLSX.read(data, { type: 'array' });

                const selector = document.getElementById('sheetSelector');
                selector.innerHTML = '<option value="">Select a sheet...</option>';
                workbook.SheetNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    selector.appendChild(option);
                });

                selector.style.display = 'block';
                document.getElementById('importBtn').style.display = 'block';
                document.getElementById('importStatus').textContent = 'File loaded from Google Drive. Select a sheet.';
            } catch (error) {
                document.getElementById('importStatus').textContent = 'Error: ' + error.message;
                console.error('Error loading file:', error);
            }
        }
    }

    // Load saved problem data
    function loadVocabulary() {
        const saved = localStorage.getItem('mathPhysicsData');
        if (saved) {
            allWords = JSON.parse(saved);
            state.remainingIdx = Array.from({ length: allWords.length }, (_, i) => i);
        }
    }

    // Save problem data
    function saveVocabulary() {
        localStorage.setItem('mathPhysicsData', JSON.stringify(allWords));
    }

    // Load saved progress
    function loadProgress() {
        const saved = localStorage.getItem('mathPhysicsProgress');
        if (saved) {
            const data = JSON.parse(saved);
            state.remainingIdx = data.remainingIdx || state.remainingIdx;
            state.wrongWords = data.wrongWords || [];
            state.correctWords = data.correctWords || [];
        }
    }

    // Save progress
    function saveProgress() {
        localStorage.setItem('mathPhysicsProgress', JSON.stringify({
            remainingIdx: state.remainingIdx,
            wrongWords: state.wrongWords,
            correctWords: state.correctWords
        }));
    }

    // Handle local file selection
    document.getElementById('fileInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            workbook = XLSX.read(data, { type: 'array' });

            const selector = document.getElementById('sheetSelector');
            selector.innerHTML = '<option value="">Select a sheet...</option>';
            workbook.SheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selector.appendChild(option);
            });

            selector.style.display = 'block';
            document.getElementById('importBtn').style.display = 'block';
            document.getElementById('importStatus').textContent = 'File loaded. Select a sheet.';
        };
        reader.readAsArrayBuffer(file);
    });

    // Handle import button click
    document.getElementById('importBtn').addEventListener('click', function () {
        const sheetName = document.getElementById('sheetSelector').value;
        if (!sheetName) {
            document.getElementById('importStatus').textContent = 'Please select a sheet.';
            return;
        }

        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        const newWords = [];
        for (let i = 0; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row[0] && row[1]) {
                newWords.push({
                    word: String(row[0]).trim(),
                    answer: String(row[1]).trim(),
                    calculationProcess: row[2] ? String(row[2]).trim() : ''
                });
            }
        }

        if (newWords.length === 0) {
            document.getElementById('importStatus').textContent = 'No valid data found in sheet.';
            return;
        }

        allWords = newWords;
        state.remainingIdx = Array.from({ length: allWords.length }, (_, i) => i);
        state.wrongWords = [];
        state.correctWords = [];

        saveVocabulary();
        saveProgress();

        document.getElementById('importStatus').textContent = `Successfully imported ${newWords.length} problems!`;

        setTimeout(() => {
            switchPanel('home');
        }, 2000);
    });

    // Normalize answer for comparison
    function normalizeAnswer(str) {
        return str.toString()
            .toLowerCase()
            .replace(/\s+/g, '')
            .replace(/[^\w\d.\/\-+=^*()]/g, '');
    }

    // Check user's answer
    function checkAnswer() {
        const userAnswer = document.getElementById('answerInput').value.trim();
        const checkResult = document.getElementById('checkResult');
        
        if (!userAnswer) {
            checkResult.textContent = 'Please enter an answer!';
            checkResult.className = '';
            checkResult.style.display = 'block';
            checkResult.style.background = 'rgba(255, 193, 7, 0.3)';
            checkResult.style.color = '#ffc107';
            checkResult.style.border = '2px solid #ffc107';
            return;
        }

        const correctAnswer = allWords[state.currentWordIdx].answer;
        const isCorrect = normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswer);

        checkResult.style.display = 'block';
        if (isCorrect) {
            checkResult.textContent = '‚úì Correct!';
            checkResult.className = 'correct';
        } else {
            checkResult.textContent = `‚úó Incorrect. Correct answer: ${correctAnswer}`;
            checkResult.className = 'incorrect';
        }

        // Auto reveal full solution after checking
        setTimeout(() => {
            revealInfo();
        }, 1000);
    }

    // Show next problem randomly
    function showNextWord() {
        const wordLabel = document.getElementById('wordLabel');
        const infoLabel = document.getElementById('infoLabel');
        const calculationInput = document.getElementById('calculationInput');
        const answerInput = document.getElementById('answerInput');
        const checkResult = document.getElementById('checkResult');

        // Clear inputs and results
        calculationInput.value = '';
        answerInput.value = '';
        infoLabel.textContent = '';
        checkResult.style.display = 'none';
        checkResult.textContent = '';

        if (state.xOnlyMode) {
            if (state.wrongWords.length === 0) {
                wordLabel.textContent = 'No more problems!';
                infoLabel.textContent = '(No "√ó" problems)';
                return;
            }

            const randomIdx = Math.floor(Math.random() * state.wrongWords.length);
            state.currentWordIdx = state.wrongWords[randomIdx];
        } else {
            const possible = state.remainingIdx.filter(idx => !state.correctWords.includes(idx));

            if (possible.length === 0) {
                const fallback = Array.from({ length: allWords.length }, (_, i) => i)
                    .filter(idx => !state.wrongWords.includes(idx) && !state.correctWords.includes(idx));

                if (fallback.length === 0) {
                    wordLabel.textContent = 'No more problems!';
                    infoLabel.textContent = '';
                    return;
                }

                const randomIdx = Math.floor(Math.random() * fallback.length);
                state.currentWordIdx = fallback[randomIdx];
            } else {
                const randomIdx = Math.floor(Math.random() * possible.length);
                state.currentWordIdx = possible[randomIdx];
            }
        }

        wordLabel.textContent = allWords[state.currentWordIdx].word;
    }

    // Reveal answer and calculation process
    function revealInfo() {
        const problem = allWords[state.currentWordIdx];
        const infoLabel = document.getElementById('infoLabel');
        infoLabel.textContent = `Answer: ${problem.answer}\n\nCalculation Process:\n${problem.calculationProcess}`;
    }

    // Mark problem as wrong (√ó)
    function markWrong() {
        if (!state.wrongWords.includes(state.currentWordIdx)) {
            state.wrongWords.push(state.currentWordIdx);
        }
        revealInfo();
        saveProgress();
    }

    // Mark problem as correct („Äá)
    function markCorrect() {
        if (!state.correctWords.includes(state.currentWordIdx)) {
            state.correctWords.push(state.currentWordIdx);
        }

        const wrongIdx = state.wrongWords.indexOf(state.currentWordIdx);
        if (wrongIdx !== -1) {
            state.wrongWords.splice(wrongIdx, 1);
        }

        revealInfo();
        saveProgress();
    }

    // Reset correct problems
    function resetCorrectWords() {
        state.remainingIdx = Array.from(new Set([...state.remainingIdx, ...state.correctWords]));
        state.correctWords = [];
        state.xOnlyMode = false;
        saveProgress();
        showNextWord();
    }

    // Switch between panels
    function switchPanel(panelName, xOnlyMode = false) {
        const panels = ['homePanel', 'quizPanel', 'importPanel'];
        panels.forEach(p => {
            document.getElementById(p).classList.remove('active');
        });

        if (panelName === 'quiz') {
            document.getElementById('quizPanel').classList.add('active');
            state.xOnlyMode = xOnlyMode;
            showNextWord();
        } else if (panelName === 'import') {
            document.getElementById('importPanel').classList.add('active');
            document.getElementById('fileInput').value = '';
            document.getElementById('sheetSelector').style.display = 'none';
            document.getElementById('importBtn').style.display = 'none';
            document.getElementById('importStatus').textContent = '';
        } else {
            document.getElementById('homePanel').classList.add('active');
        }
    }

    // Allow Enter key to check answer
    document.getElementById('answerInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkAnswer();
        }
    });

    // Event listeners
    document.getElementById('btnStart').addEventListener('click', () => switchPanel('quiz', false));
    document.getElementById('btnReset').addEventListener('click', resetCorrectWords);
    document.getElementById('btnXOnly').addEventListener('click', () => switchPanel('quiz', true));
    document.getElementById('btnImport').addEventListener('click', () => switchPanel('import'));
    document.getElementById('driveBtn').addEventListener('click', openDrivePicker);
    document.getElementById('btnCheck').addEventListener('click', checkAnswer);
    document.getElementById('btnNext').addEventListener('click', showNextWord);
    document.getElementById('btnCorrect').addEventListener('click', markCorrect);
    document.getElementById('btnWrong').addEventListener('click', markWrong);
    document.getElementById('btnHome').addEventListener('click', () => switchPanel('home'));
    document.getElementById('backBtn').addEventListener('click', () => switchPanel('home'));

    // Initialize Google APIs when scripts load
    window.addEventListener('load', () => {
        if (typeof gapi !== 'undefined') {
            gapiLoaded();
        }
        if (typeof google !== 'undefined' && google.accounts) {
            gisLoaded();
        }
    });

    // Initialize app
    loadVocabulary();
    loadProgress();
</script>
```

</body>

</html>